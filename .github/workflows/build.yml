name: Build Kernel

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    container:
      image: ghcr.io/rovars/docker:cirrus

    env:
      TG_TOKEN: ${{ secrets.TG_TOKEN }}
      TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
      WORKSPACE: ${{ github.workspace }}/build_env
      CCACHE_DIR: ${{ github.workspace }}/.ccache
      USE_CCACHE: 1

    steps:
      - name: Checkout This Repo
        uses: actions/checkout@v4

      - name: Clone ROM (AnyKernel3)
        uses: actions/checkout@v4
        with:
          repository: rovars/rom
          token: ${{ secrets.GH_TOKEN }}
          path: build_env/rom

      - name: Clone Private Kernel
        uses: actions/checkout@v4
        with:
          repository: rovars/kernel_realme_RMX2185
          token: ${{ secrets.GH_TOKEN }}
          ref: lineage-17.1
          path: build_env/kernel

      - name: Cache Ccache
        uses: actions/cache@v4
        with:
          path: .ccache
          key: ${{ runner.os }}-kernel-ccache-${{ hashFiles('build_env/kernel/arch/arm64/configs/RMX2185_defconfig') }}
          restore-keys: |
            ${{ runner.os }}-kernel-ccache-

      - name: Install Dependencies
        run: |
          apt-get update
          apt-get install -y bc bison build-essential ccache curl flex g++-multilib gcc-multilib git gnupg gperf libxml2 libxml2-utils lzop pngcrush rsync schedtool squashfs-tools xsltproc zip zlib1g-dev libssl-dev libelf-dev wget

      - name: Setup Toolchains
        run: |
          mkdir -p $WORKSPACE
          echo "==> Cloning Toolchains..."
          git clone -q --depth=1 -b lineage-17.1 https://github.com/LineageOS/android_prebuilts_gcc_linux-x86_aarch64_aarch64-linux-android-4.9 $WORKSPACE/gcc64
          git clone -q --depth=1 -b lineage-17.1 https://github.com/LineageOS/android_prebuilts_gcc_linux-x86_arm_arm-linux-androideabi-4.9 $WORKSPACE/gcc32
          
          echo "==> Downloading Clang..."
          mkdir -p $WORKSPACE/clang
          wget -q https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/tags/android-10.0.0_r41/clang-r353983c1.tar.gz -O $WORKSPACE/clang.tar.gz
          tar -xzf $WORKSPACE/clang.tar.gz -C $WORKSPACE/clang
          rm $WORKSPACE/clang.tar.gz

      - name: Build and Package
        run: |
          tg_post() {
              local input="$1"
              local caption="$2"
              [[ -z "$TG_TOKEN" || -z "$TG_CHAT_ID" ]] && return 0
              if [[ -f "$input" ]]; then
                  curl -s -F document=@"$input" -F chat_id="$TG_CHAT_ID" -F caption="$caption" -F parse_mode=HTML "https://api.telegram.org/bot$TG_TOKEN/sendDocument" > /dev/null
              else
                  curl -s -X POST "https://api.telegram.org/bot$TG_TOKEN/sendMessage" -d "chat_id=$TG_CHAT_ID" -d "text=$input" -d "parse_mode=HTML" -d "disable_web_page_preview=true" > /dev/null
              fi
          }

          tg_post "<b>Kernel Build Started</b>
          Device: RMX2185
          Job: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          echo "==> Starting Kernel Build..."
          cd $WORKSPACE/kernel
          export ARCH=arm64 SUBARCH=arm64 HEADER_ARCH=arm64
          export KBUILD_BUILD_USER=nobody KBUILD_BUILD_HOST=android-build
          export PATH="$WORKSPACE/clang/bin:$WORKSPACE/gcc64/bin:$WORKSPACE/gcc32/bin:$PATH"
          
          ccache -M 5G
          ccache -o compression=true
          ccache -s

          make O=out ARCH=arm64 RMX2185_defconfig
          make O=out -j$(nproc --all) \
              ARCH=arm64 SUBARCH=arm64 CC="ccache clang" \
              CLANG_TRIPLE=aarch64-linux-gnu- \
              CROSS_COMPILE=aarch64-linux-android- \
              CROSS_COMPILE_ARM32=arm-linux-androideabi- \
              INSTALL_MOD_STRIP=1 2>&1 | tee build.txt

          if [ ${PIPESTATUS[0]} -ne 0 ]; then
              echo "==> Error: Build failed!"
              tg_post "build.txt" "<b>Kernel Build Failed!</b> Log attached."
              exit 1
          fi

          echo "==> Packaging Result..."
          cd $WORKSPACE/rom/AnyKernel3
          cp $WORKSPACE/kernel/out/arch/arm64/boot/Image.gz-dtb .
          ksu_ver=$(sed -n 's/.*DKSU_VERSION=\([0-9]*\).*/\1/p' $WORKSPACE/kernel/drivers/kernelsu/Makefile | head -n 1)
          zipn="RMX2185-4.9.190+ksu_${ksu_ver}-$(date +%y%m%d).zip"
          zip -r9 "${zipn}" . -x ".git*" "README.md" "*placeholder"

          echo "==> Done: Build successful!"
          tg_post "${zipn}" "<b>Kernel Build Successful!</b>
          File: <code>${zipn}</code>"
          tg_post "$WORKSPACE/kernel/build.txt" "Full Build Log"
          
          ccache -s
