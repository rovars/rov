name: Build Kernel

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    container:
      image: ghcr.io/rovars/docker:cirrus
      options: --user root

    env:
      TG_TOKEN: ${{ secrets.TG_TOKEN }}
      TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
      GH_TOKEN: ${{ secrets.GH_TOKEN }}
      WORKSPACE: /tmp/build_env
      CCACHE_DIR: /tmp/.ccache
      USE_CCACHE: 1

    steps:
      - name: Clone ROM and Kernel
        run: |
          mkdir -p $WORKSPACE
          echo "==> Cloning ROM (AnyKernel3)..."
          git clone -q --depth=1 https://rovars:${GH_TOKEN}@github.com/rovars/rom $WORKSPACE/rom
          
          echo "==> Cloning Private Kernel..."
          git clone -q --depth=1 -b lineage-17.1 https://rovars:${GH_TOKEN}@github.com/rovars/kernel_realme_RMX2185 $WORKSPACE/kernel

      - name: Setup Toolchains
        run: |
          echo "==> Cloning Toolchains..."
          git clone -q --depth=1 -b lineage-17.1 https://github.com/LineageOS/android_prebuilts_gcc_linux-x86_aarch64_aarch64-linux-android-4.9 $WORKSPACE/gcc64
          git clone -q --depth=1 -b lineage-17.1 https://github.com/LineageOS/android_prebuilts_gcc_linux-x86_arm_arm-linux-androideabi-4.9 $WORKSPACE/gcc32
          
          echo "==> Downloading Clang..."
          mkdir -p $WORKSPACE/clang
          wget -q https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/tags/android-10.0.0_r41/clang-r353983c1.tar.gz -O $WORKSPACE/clang.tar.gz
          tar -xzf $WORKSPACE/clang.tar.gz -C $WORKSPACE/clang
          rm $WORKSPACE/clang.tar.gz

      - name: Build and Package
        run: |
          /opt/cirrus_env tg_post "<b>Kernel Build Started</b>
          Device: RMX2185
          Job: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          echo "==> Starting Kernel Build..."
          cd $WORKSPACE/kernel
          export ARCH=arm64 SUBARCH=arm64 HEADER_ARCH=arm64
          export KBUILD_BUILD_USER=nobody KBUILD_BUILD_HOST=android-build
          export PATH="$WORKSPACE/clang/bin:$WORKSPACE/gcc64/bin:$WORKSPACE/gcc32/bin:$PATH"
          
          mkdir -p $CCACHE_DIR
          ccache -M 5G
          ccache -o compression=true
          ccache -s

          make O=out ARCH=arm64 RMX2185_defconfig
          make O=out -j$(nproc --all) \
              ARCH=arm64 SUBARCH=arm64 CC="ccache clang" \
              CLANG_TRIPLE=aarch64-linux-gnu- \
              CROSS_COMPILE=aarch64-linux-android- \
              CROSS_COMPILE_ARM32=arm-linux-androideabi- \
              INSTALL_MOD_STRIP=1 2>&1 | tee build.txt

          if [ ${PIPESTATUS[0]} -ne 0 ]; then
              echo "==> Error: Build failed!"
              /opt/cirrus_env tg_post "build.txt" "<b>Kernel Build Failed!</b> Log attached."
              exit 1
          fi

          echo "==> Packaging Result..."
          cd $WORKSPACE/rom/AnyKernel3
          cp $WORKSPACE/kernel/out/arch/arm64/boot/Image.gz-dtb .
          ksu_ver=$(sed -n 's/.*DKSU_VERSION=\([0-9]*\).*/\1/p' $WORKSPACE/kernel/drivers/kernelsu/Makefile | head -n 1)
          zipn="RMX2185-4.9.190+ksu_${ksu_ver}-$(date +%y%m%d).zip"
          zip -r9 "${zipn}" . -x ".git*" "README.md" "*placeholder"

          echo "==> Done: Build successful!"
          /opt/cirrus_env tg_post "${zipn}" "<b>Kernel Build Successful!</b>
          File: <code>${zipn}</code>"
          /opt/cirrus_env tg_post "$WORKSPACE/kernel/build.txt" "Full Build Log"
          
          ccache -s
