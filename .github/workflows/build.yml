name: Build Kernel

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    container:
      image: ghcr.io/rovars/docker:cirrus
      options: --user root

    defaults:
      run:
        shell: bash

    env:
      TG_TOKEN: ${{ secrets.TG_TOKEN }}
      TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
      GH_TOKEN: ${{ secrets.GH_TOKEN }}
      USE_CCACHE: 1

    steps:
      - name: Checkout This Repo
        uses: actions/checkout@v4

      - name: Setup Environment Variables
        run: |
          echo "WORKSPACE=$GITHUB_WORKSPACE/build_env" >> $GITHUB_ENV
          echo "CCACHE_DIR=$GITHUB_WORKSPACE/.ccache" >> $GITHUB_ENV

      - name: Clone ROM and Kernel
        run: |
          mkdir -p $WORKSPACE
          git clone -q --depth=1 https://rovars:${GH_TOKEN}@github.com/rovars/rom $WORKSPACE/rom
          git clone -q --depth=1 -b lineage-17.1 https://rovars:${GH_TOKEN}@github.com/rovars/kernel_realme_RMX2185 $WORKSPACE/kernel

      - name: Cache Ccache
        uses: actions/cache@v5
        with:
          path: .ccache
          key: kernel-ccache-rmx2185-${{ github.run_id }}
          restore-keys: |
            kernel-ccache-rmx2185-

      - name: Setup Toolchains
        run: |
          git clone -q --depth=1 -b lineage-17.1 https://github.com/LineageOS/android_prebuilts_gcc_linux-x86_aarch64_aarch64-linux-android-4.9 $WORKSPACE/gcc64
          git clone -q --depth=1 -b lineage-17.1 https://github.com/LineageOS/android_prebuilts_gcc_linux-x86_arm_arm-linux-androideabi-4.9 $WORKSPACE/gcc32
          git clone -q --depth=1 https://rovars:${GH_TOKEN}@github.com/rovars/clang $WORKSPACE/clang

      - name: Build Kernel
        run: |
          /opt/cirrus_env tg_post "<b>Kernel Build Started</b>
          Device: RMX2185
          Job: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          # Export Ccache Configurations
          export CCACHE_DIR=$GITHUB_WORKSPACE/.ccache
          export CCACHE_BASEDIR=$GITHUB_WORKSPACE
          export CCACHE_COMPILERCHECK=content
          export CCACHE_NOHASHDIR=true
          export CCACHE_SLOPPINESS=file_macro,time_macros,include_file_mtime,include_file_ctime,modules
          export USE_CCACHE=1

          mkdir -p $CCACHE_DIR
          ccache -M 5G
          ccache -o compression=true

          cd $WORKSPACE/kernel
          export ARCH=arm64 SUBARCH=arm64 HEADER_ARCH=arm64
          export KBUILD_BUILD_USER=nobody KBUILD_BUILD_HOST=android-build
          export PATH="$WORKSPACE/clang/bin:$WORKSPACE/gcc64/bin:$WORKSPACE/gcc32/bin:$PATH"

          make O=out ARCH=arm64 RMX2185_defconfig
          make O=out -j$(nproc --all) \
              ARCH=arm64 SUBARCH=arm64 CC="ccache clang" \
              CLANG_TRIPLE=aarch64-linux-gnu- \
              CROSS_COMPILE=aarch64-linux-android- \
              CROSS_COMPILE_ARM32=arm-linux-androideabi- \
              INSTALL_MOD_STRIP=1 2>&1 | tee build.txt

          if [ ${PIPESTATUS[0]} -ne 0 ]; then
              /opt/cirrus_env tg_post "build.txt" "<b>Kernel Build Failed!</b> Log attached."
              exit 1
          fi
          echo "Build Successfull" >> build.txt
          ccache -s

      - name: Packaging Result
        run: |
          cd $WORKSPACE/rom/AnyKernel3
          cp $WORKSPACE/kernel/out/arch/arm64/boot/Image.gz-dtb .
          ksu_ver=$(sed -n 's/.*DKSU_VERSION=\([0-9]*\).*/\1/p' $WORKSPACE/kernel/drivers/kernelsu/Makefile | head -n 1)
          [ -z "$ksu_ver" ] && ksu_ver="no-ksu"
          zipn="RMX2185-4.9.190-${ksu_ver}-$(date +%y%m%d).zip"
          zip -r9 "${zipn}" . -x ".git*" "README.md" "*placeholder"
          /opt/cirrus_env tg_post "${zipn}"
          /opt/cirrus_env tg_post "$WORKSPACE/kernel/build.txt" "Build successful log"
